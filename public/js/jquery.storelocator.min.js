/*
* storeLocator v1.4.9 - jQuery Google Maps Store Locator Plugin
* (c) Copyright 2013, Bjorn Holine (http://www.bjornblog.com)
* Released under the MIT license
* Distance calculation function by Chris Pietschmann: http://pietschsoft.com/post/2008/02/01/Calculate-Distance-Between-Geocodes-in-C-and-JavaScript.aspx
*/

(function(a){a.fn.storeLocator=function(b){var c=a.extend({mapDiv:"map",listDiv:"loc-list",formContainerDiv:"form-container",formID:"user-location",inputID:"address",zoomLevel:12,pinColor:"fe7569",pinTextColor:"000000",lengthUnit:"m",storeLimit:26,distanceAlert:60,dataType:"xml",dataLocation:"locations.xml",listColor1:"ffffff",listColor2:"eeeeee",originMarker:false,originpinColor:"blue",bounceMarker:true,slideMap:true,modalWindow:false,overlayDiv:"overlay",modalWindowDiv:"modal-window",modalContentDiv:"modal-content",modalCloseIconDiv:"close-icon",defaultLoc:false,defaultLat:"",defaultLng:"",autoGeocode:false,maxDistance:false,maxDistanceID:"maxdistance",fullMapStart:false,noForm:false,loading:false,loadingDiv:"loading-map",featuredLocations:false,infowindowTemplatePath:"templates/infowindow-description.html",listTemplatePath:"templates/location-list-description.html",KMLinfowindowTemplatePath:"templates/kml-infowindow-description.html",KMLlistTemplatePath:"templates/kml-location-list-description.html",callbackBeforeSend:null,callbackComplete:null,callbackSuccess:null,callbackModalOpen:null,callbackModalClose:null,jsonpCallback:null,geocodeErrorAlert:"Geocode was not successful for the following reason: ",addressErrorAlert:"Unable to find address",autoGeocodeErrorAlert:"Automatic location detection failed. Please fill in your address or zip code.",distanceErrorAlert:"Unfortunately, our closest location is more than ",mileLang:"mile",milesLang:"miles",kilometerLang:"kilometer",kilometersLang:"kilometers"},b);
return this.each(function(){var h=a(this);var e,g;f();function f(){if(c.dataType==="kml"){a.get(c.KMLinfowindowTemplatePath,function(i){var j=i;g=Handlebars.compile(j);
});a.get(c.KMLlistTemplatePath,function(i){var j=i;e=Handlebars.compile(j);d();});}else{a.get(c.infowindowTemplatePath,function(i){var j=i;g=Handlebars.compile(j);
});a.get(c.listTemplatePath,function(i){var j=i;e=Handlebars.compile(j);d();});}}function d(){var i,y,s,o,B,m;var r=[];var k=[];var w=[];var x=[];var u="storeLocator";
function z(){r=[];k=[];w=[];x=[];a(document).off("click."+u,"#"+c.listDiv+" li");}if(c.modalWindow===true){h.wrap('<div id="'+c.overlayDiv+'"><div id="'+c.modalWindowDiv+'"><div id="'+c.modalContentDiv+'">');
a("#"+c.modalWindowDiv).prepend('<div id="'+c.modalCloseIconDiv+'"></div>');a("#"+c.overlayDiv).hide();}if(c.slideMap===true){h.hide();}var l={};if(c.lengthUnit==="km"){l.EarthRadius=6367;
}else{l.EarthRadius=3956;}l.ToRadian=function(D){return D*(Math.PI/180);};l.DiffRadian=function(E,D){return l.ToRadian(D)-l.ToRadian(E);};l.CalcDistance=function(H,G,F,E,D){return D*2*Math.asin(Math.min(1,Math.sqrt((Math.pow(Math.sin((l.DiffRadian(H,F))/2),2)+Math.cos(l.ToRadian(H))*Math.cos(l.ToRadian(F))*Math.pow(Math.sin((l.DiffRadian(G,E))/2),2)))));
};j();function j(){if(c.defaultLoc===true){var D=new C();var E=new google.maps.LatLng(c.defaultLat,c.defaultLng);D.geocode(E,function(G){if(G!==null){var F=G.address;
p(c.defaultLat,c.defaultLng,F);}else{alert(c.addressErrorAlert);}});}if(c.fullMapStart===true){p();}if(c.autoGeocode===true){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(q,A);
}}}function v(){geocoder=new google.maps.Geocoder();this.geocode=function(D,E){geocoder.geocode({address:D},function(H,G){if(G===google.maps.GeocoderStatus.OK){var F={};
F.latitude=H[0].geometry.location.lat();F.longitude=H[0].geometry.location.lng();E(F);}else{alert(c.geocodeErrorAlert+G);E(null);}});};}function C(){geocoder=new google.maps.Geocoder();
this.geocode=function(E,D){geocoder.geocode({latLng:E},function(H,G){if(G===google.maps.GeocoderStatus.OK){if(H[0]){var F={};F.address=H[0].formatted_address;
D(F);}}else{alert(c.geocodeErrorAlert+G);D(null);}});};}function t(D,E){return Math.round(D*Math.pow(10,E))/Math.pow(10,E);}function q(D){var E=new C();
var F=new google.maps.LatLng(D.coords.latitude,D.coords.longitude);E.geocode(F,function(H){if(H!==null){var G=H.address;p(D.coords.latitude,D.coords.longitude,G);
}else{alert(c.addressErrorAlert);}});}function A(D){alert(c.autoGeocodeErrorAlert);}function n(G){var F=a("#"+c.inputID).val();if(F===""){j();}else{var E=new v();
var D=F;E.geocode(D,function(H){if(H!==null){y=H.latitude;s=H.longitude;p(y,s,F,G);}else{alert(c.addressErrorAlert);}});}}a(function(){function D(F){F.preventDefault();
if(c.maxDistance===true){var E=a("#"+c.maxDistanceID).val();n(E);}else{n();}}if(c.noForm===true){a(document).on("click."+u,"#"+c.formContainerDiv+" #submit",function(E){D(E);
});a(document).on("keyup."+u,function(E){if(E.keyCode===13&&a("#"+c.inputID).is(":focus")){D(E);}});}else{a(document).on("submit."+u,"#"+c.formID,function(E){D(E);
});}});function p(D,F,E,G){a(function(){google.maps.visualRefresh=true;var H;if(c.dataType==="kml"){H="xml";}else{H=c.dataType;}a.ajax({type:"GET",url:c.dataLocation+(c.dataType==="jsonp"?(c.dataLocation.match(/\?/)?"&":"?")+"callback=?":""),dataType:H,jsonpCallback:(c.dataType==="jsonp"?c.jsonpCallback:null),beforeSend:function(){if(c.callbackBeforeSend){c.callbackBeforeSend.call(this);
}if(c.loading===true){a("#"+c.formContainerDiv).append('<div id="'+c.loadingDiv+'"></div>');}},complete:function(K,J,I){if(c.callbackComplete){c.callbackComplete.call(this,K,J,I);
}if(c.loading===true){a("#"+c.loadingDiv).remove();}},success:function(L,N,I){if(c.callbackSuccess){c.callbackSuccess.call(this,L,N,I);}var K=0;var M;if(c.fullMapStart===true&&a("#"+c.mapDiv).hasClass("mapOpen")===false){M=true;
}else{z();}a("#"+c.mapDiv).addClass("mapOpen");if(c.dataType==="json"||c.dataType==="jsonp"){a.each(L,function(){var P,Q,R={};for(P in this){Q=this[P];
if(P==="web"){if(Q){Q=Q.replace("http://","");}}R[P]=Q;}if(!R.distance){R.distance=l.CalcDistance(D,F,R.lat,R.lng,l.EarthRadius);}if(c.maxDistance===true&&M!==true&&G){if(R.distance<G){r[K]=R;
}else{return;}}else{r[K]=R;}K++;});}else{if(c.dataType==="kml"){a(L).find("Placemark").each(function(){var P={name:a(this).find("name").text(),lat:a(this).find("coordinates").text().split(",")[1],lng:a(this).find("coordinates").text().split(",")[0],description:a(this).find("description").text()};
P.distance=l.CalcDistance(D,F,P.lat,P.lng,l.EarthRadius);if(c.maxDistance===true&&M!==true&&G){if(P.distance<G){r[K]=P;}else{return;}}else{r[K]=P;}K++;
});}else{a(L).find("marker").each(function(){var P={name:a(this).attr("name"),lat:a(this).attr("lat"),lng:a(this).attr("lng"),address:a(this).attr("address"),address2:a(this).attr("address2"),city:a(this).attr("city"),state:a(this).attr("state"),postal:a(this).attr("postal"),country:a(this).attr("country"),phone:a(this).attr("phone"),email:a(this).attr("email"),web:a(this).attr("web"),hours1:a(this).attr("hours1"),hours2:a(this).attr("hours2"),hours3:a(this).attr("hours3"),category:a(this).attr("category"),featured:a(this).attr("featured")};
if(P.web){P.web=P.web.replace("http://","");}P.distance=l.CalcDistance(D,F,P.lat,P.lng,l.EarthRadius);if(c.maxDistance===true&&M!==true&&G){if(P.distance<G){r[K]=P;
}else{return;}}else{r[K]=P;}K++;});}}function J(P){P.sort(function(R,Q){return((R.distance<Q.distance)?-1:((R.distance>Q.distance)?1:0));});}J(r);if(c.featuredLocations===true){k=a.grep(r,function(Q,P){return Q.featured==="true";
});w=a.grep(r,function(Q,P){return Q.featured!=="true";});r=[];r=k.concat(w);}var O=(c.lengthUnit==="km")?c.kilometersLang:c.milesLang;if(c.maxDistance===true&&M!==true&&G){if(r[0]===undefined||r[0]["distance"]>G){alert(c.distanceErrorAlert+G+" "+O);
return;}}else{if(c.distanceAlert!==-1&&r[0]["distance"]>c.distanceAlert){alert(c.distanceErrorAlert+c.distanceAlert+" "+O);}}a(function(){var ag,ac,V={};
function W(ah){for(ag in r[ah]){ac=r[ah][ag];if(ag==="distance"){ac=t(ac,2);}V[ag]=ac;}}function R(al){W(al.get("id"));var aj;if(V.distance<=1){if(c.lengthUnit==="km"){aj=c.kilometerLang;
}else{aj=c.mileLang;}}else{if(c.lengthUnit==="km"){aj=c.kilometersLang;}else{aj=c.milesLang;}}var ak=al.get("id");if(c.storeLimit===-1||c.storeLimit>26){var ai=ak+1;
}else{var ai=String.fromCharCode("A".charCodeAt(0)+ak);}var ah={location:[a.extend(V,{markerid:ak,marker:ai,length:aj,origin:E})]};return ah;}if(c.slideMap===true){h.slideDown();
}if(c.modalWindow===true){if(c.callbackModalOpen){c.callbackModalOpen.call(this);}function Q(){if(c.callbackModalOpen){c.callbackModalOpen.call(this);}a("#"+c.overlayDiv).hide();
}a("#"+c.overlayDiv).fadeIn();a(document).on("click."+u,"#"+c.modalCloseIconDiv+", #"+c.overlayDiv,function(){Q();});a(document).on("click."+u,"#"+c.modalWindowDiv,function(ah){ah.stopPropagation();
});a(document).on("keyup."+u,function(ah){if(ah.keyCode===27){Q();}});}if((c.fullMapStart===true&&M===true)||c.zoomLevel===0){var aa={mapTypeId:google.maps.MapTypeId.ROADMAP};
var T=new google.maps.LatLngBounds();}else{var aa={zoom:c.zoomLevel,center:new google.maps.LatLng(D,F),mapTypeId:google.maps.MapTypeId.ROADMAP};}var ae=new google.maps.Map(document.getElementById(c.mapDiv),aa);
h.data("map",ae);var Y=new google.maps.InfoWindow();if(c.storeLimit===-1||(r.length-1)<c.storeLimit-1){m=r.length-1;}else{m=c.storeLimit-1;}if(c.originMarker===true&&c.fullMapStart===false){var Z=new google.maps.LatLng(D,F);
var U=new google.maps.Marker({position:Z,map:ae,icon:"http://maps.google.com/mapfiles/ms/icons/"+c.originpinColor+"-dot.png",draggable:false});}for(var X=0;
X<=m;X++){var af=String.fromCharCode("A".charCodeAt(0)+X);var ad=new google.maps.LatLng(r[X]["lat"],r[X]["lng"]);U=P(ad,r[X]["name"],r[X]["address"],af);
U.set("id",X);x[X]=U;if((c.fullMapStart===true&&M===true)||c.zoomLevel===0){T.extend(ad);}S(U);}if((c.fullMapStart===true&&M===true)||c.zoomLevel===0){ae.fitBounds(T);
}a("#"+c.listDiv+" ul").empty();a(x).each(function(ah,ai){var aj=String.fromCharCode("A".charCodeAt(0)+ah);var ak=x[ah];ab(ak);});function ab(ai){var ah=R(ai);
var aj=e(ah);a("#"+c.listDiv+" ul").append(aj);}a(document).on("click."+u,"#"+c.listDiv+" li",function(){var aj=a(this).data("markerid");var ai=x[aj];a("#"+c.listDiv+" li").removeClass("list-focus");
a("#"+c.listDiv+" li[data-markerid="+aj+"]").addClass("list-focus");ae.panTo(ai.getPosition());var ah="left";if(c.bounceMarker===true){ai.setAnimation(google.maps.Animation.BOUNCE);
setTimeout(function(){ai.setAnimation(null);S(ai,ah);},700);}else{S(ai,ah);}});a("#"+c.listDiv+" ul li:even").css("background","#"+c.listColor1);a("#"+c.listDiv+" ul li:odd").css("background","#"+c.listColor2);
function P(ah,ak,aj,am){var al=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+am+"|"+c.pinColor+"|"+c.pinTextColor,new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34));
if(c.storeLimit===-1||c.storeLimit>26){var ai=new google.maps.Marker({position:ah,map:ae,draggable:false});}else{var ai=new google.maps.Marker({position:ah,map:ae,icon:al,draggable:false});
}return ai;}function S(ak,aj){var ai=R(ak);var ah=g(ai);if(aj==="left"){Y.setContent(ah);Y.open(ak.get("map"),ak);}else{google.maps.event.addListener(ak,"click",function(){Y.setContent(ah);
Y.open(ak.get("map"),ak);a("#"+c.listDiv+" li").removeClass("list-focus");markerId=ak.get("id");a("#"+c.listDiv+" li[data-markerid="+markerId+"]").addClass("list-focus");
var al=a("#"+c.listDiv),am=a("#"+c.listDiv+" li[data-markerid="+markerId+"]");a("#"+c.listDiv).animate({scrollTop:am.offset().top-al.offset().top+al.scrollTop()});
});}}});}});});}}});};})(jQuery);